<div class="cart-container">
  <div class="cart-header">
    <h2>üõí Shopping Cart</h2>
    <button class="btn-secondary" (click)="goToOrders()">View Orders</button>
  </div>

  @if (loading) {
    <div class="loading-spinner">
      <p>Loading cart...</p>
    </div>
  }

  @if (error) {
    <div class="error-message">{{ error }}</div>
  }

  @if (success) {
    <div class="success-message">{{ success }}</div>
  }

  @if (!loading && cartItems.length === 0) {
    <div class="empty-cart">
      <div class="empty-cart-icon">üõí</div>
      <h3>Your cart is empty</h3>
      <p>Add some courses to get started!</p>
      <a routerLink="/courses" class="btn-primary">Browse Courses</a>
    </div>
  }

  @if (!loading && cartItems.length > 0) {
    <div class="cart-content">
      <div class="cart-items">
        @for (item of cartItems; track item.courseId) {
          <div class="cart-item">
            <div class="item-info">
              <h4>{{ getCourseName(item.courseId) }}</h4>
              <p class="item-description">{{ getCourseDescription(item.courseId) }}</p>
              <div class="item-details">
                <span class="price">${{ item.price }}</span>
                <span class="quantity">√ó {{ item.quantity }}</span>
                @if (item.discount > 0) {
                  <span class="discount">-{{ item.discount }}%</span>
                }
              </div>
            </div>
            <div class="item-actions">
              <span class="item-total">${{ getItemTotal(item) | number:'1.2-2' }}</span>
              <button class="btn-remove" (click)="removeItem(item.courseId)" title="Remove">
                üóëÔ∏è
              </button>
            </div>
          </div>
        }
      </div>

      <div class="cart-summary">
        <h3>Order Summary</h3>
        <div class="summary-row">
          <span>Items ({{ cartItems.length }})</span>
          <span>${{ getCartTotal() | number:'1.2-2' }}</span>
        </div>
        <div class="summary-total">
          <span>Total</span>
          <span>${{ getCartTotal() | number:'1.2-2' }}</span>
        </div>
        <button class="btn-checkout" (click)="openPaymentModal()">
          Proceed to Checkout
        </button>
      </div>
    </div>
  }

  <!-- Payment Modal -->
  @if (showPaymentModal) {
    <div class="modal-overlay" (click)="closePaymentModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üí≥ Select Payment Method</h3>
          <button class="btn-close" (click)="closePaymentModal()">&times;</button>
        </div>

        <div class="payment-methods">
          @for (method of paymentMethods; track method.title) {
            <div
              class="payment-method"
              [class.selected]="selectedPaymentMethod === method.title"
              (click)="selectedPaymentMethod = method.title">
              <div class="method-icon">
                @if (method.imageUrl) {
                  <img [src]="method.imageUrl" [alt]="method.title">
                } @else {
                  @switch (method.title) {
                    @case ('Bank') { üè¶ }
                    @case ('IBox terminal') { üìü }
                    @case ('Visa') { üí≥ }
                    @default { üí∞ }
                  }
                }
              </div>
              <div class="method-info">
                <h4>{{ method.title }}</h4>
                <p>{{ method.description }}</p>
              </div>
              <div class="method-select">
                <input
                  type="radio"
                  [name]="'payment'"
                  [value]="method.title"
                  [(ngModel)]="selectedPaymentMethod">
              </div>
            </div>
          }
        </div>

        <!-- Visa Form -->
        @if (selectedPaymentMethod === 'Visa') {
          <div class="visa-form">
            <h4>Card Details</h4>
            <div class="form-group">
              <label for="holder">Card Holder Name</label>
              <input
                type="text"
                id="holder"
                [(ngModel)]="visaForm.holder"
                placeholder="John Doe">
            </div>
            <div class="form-group">
              <label for="cardNumber">Card Number</label>
              <input
                type="text"
                id="cardNumber"
                [(ngModel)]="visaForm.cardNumber"
                placeholder="1234 5678 9012 3456"
                maxlength="16">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="monthExpire">Month</label>
                <select id="monthExpire" [(ngModel)]="visaForm.monthExpire">
                  @for (month of [1,2,3,4,5,6,7,8,9,10,11,12]; track month) {
                    <option [value]="month">{{ month }}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label for="yearExpire">Year</label>
                <select id="yearExpire" [(ngModel)]="visaForm.yearExpire">
                  @for (year of [2024,2025,2026,2027,2028,2029,2030]; track year) {
                    <option [value]="year">{{ year }}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label for="cvv2">CVV</label>
                <input
                  type="password"
                  id="cvv2"
                  [(ngModel)]="visaForm.cvv2"
                  placeholder="123"
                  maxlength="4">
              </div>
            </div>
          </div>
        }

        @if (error) {
          <div class="error-message modal-error">{{ error }}</div>
        }

        <div class="modal-footer">
          <div class="payment-total">
            <span>Total to pay:</span>
            <span class="total-amount">${{ getCartTotal() | number:'1.2-2' }}</span>
          </div>
          <button
            class="btn-pay"
            (click)="processPayment()"
            [disabled]="processingPayment">
            @if (processingPayment) {
              Processing...
            } @else {
              Pay Now
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
